## webpack 打包原理

### webpack ？

- webpack 是一个 应用程序的静态模块打包器。

- 当 webpack 处理应用程序时，他会递归地构建一个依赖关系图，其中包含应用程序需要的每个模块，然后将所有这些模块打包成一个或多个 bundle。
- webpack文件放在哪里都可 ，因为还要在项目的配置文件中 使用config告知这个配置文件的目录。
- 在服务器端渲染时，服务端和客户端代码分别打包
- Webpack 之所以能成功，在于我们可以将它看成一个黑盒子，不需要操心内部是怎么实现的，我们只要简单的会用这个工具。

### 核心概念

- Entry： 入口，作为构建内部依赖图的开始

- Output ：输出， 输出目录及其命名 默认为 ./dist

- Module： 模块， webpack 里 一切皆模块，一个模块对应一个文件。Webpack 会从配置的 Entry 开始递归找出所有依赖的模块。

  ```js
  module: {
    rules: [
      {
        test: /(.js|.jsx)$/,
        use: ['babel-loader'],
        exclude: /node_modules/
      }
    ]
  }
  ```

  - 在里面配置loader，文件转义器，让webpack可以识别除js之外类型的文件，jsx，css，sass等
    - 加载文件：file-loader
    - 转换脚本语言：babel-loader，ts-loader，
    - 转换样式：css-loader，style-loader
    - 检查代码：eslint-loader
  - rules就是规则的集合：test匹配文件类型，use使用什么loader，exclude表示不编译的文件集合，一般不会编译node_modules

- Chunk： 代码块， 一个 Chunk 由多个模块组合而成，用于代码合并与分割。

- Plugin： 插件，目的在于解决loader无法实现的其他事

  

### 构建流程

1. 初始化参数：从配置文件和 Shell 语句中读取与合并参数,得出最终的参数。
2. 开始编译：用上一步得到的参数初始化 Compiler 对象,加载所有配置的插件,执行对象的 run 方法开始执行编译。
3. 确定入口：根据配置中的 entry 找出所有的入口文件。（@babel/parser 将文件内容转为AST抽象语法树）
4. 编译模块：从入口文件出发,调用所有配置的 Loader 对模块进行翻译,再找出该模块依赖的模块,再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理。
（找出所有依赖模块，ast转换成code，递归解析所有依赖项，生成依赖关系图）
5. 完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后,得到了每个模块被翻译后的最终内容以及它们之间的依赖关系。
6. 输出资源：根据入口和模块之间的依赖关系,组装成一个个包含多个模块的 Chunk,再把每个 Chunk 转换成一个单独的文件加入到输出列表,这步是可以修改输出内容的最后机会。
7. 输出完成：在确定好输出内容后,根据配置确定输出的路径和文件名,把文件内容写入到文件系统。

### 流程细节

构建流程可分为三大阶段：

1. 初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler。
2. 编译：从 Entry 发出，针对每个 Module 串行调用对应的 Loader 去翻译文件内容，再找到该 Module 依赖的 Module，递归地进行编译处理。
3. 输出：对编译后的 Module 组合成 Chunk，把 Chunk 转换成文件，输出到文件系统。

如果只执行一次构建，以上阶段将会按照顺序各执行一次。但在开启监听模式下，流程如下：

![](http://webpack.wuhaolin.cn/5%E5%8E%9F%E7%90%86/img/5-1%E7%9B%91%E5%90%AC%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B.png)

在每个大阶段中又会发生很多事件，Webpack 会把这些事件广播出来供给 Plugin 使用

### 优化

- 缩小文件搜索范围

- 压缩代码 

  可以通过 GZIP 算法对文件压缩，还可以对文本本身进行压缩（对文本本身进行压缩的作用除了有提升网页加载速度的优势外，还具有混淆源码的作用。 由于压缩后的代码可读性非常差，就算别人下载到了网页的代码，也大大增加了代码分析和改造的难度。）

  压缩 js [UglifyJS](https://github.com/mishoo/UglifyJS2) 

  压缩 css [cssnano](http://cssnano.co/)

- 开启模块热替换

  当一个源码发生变化时，只重新编译发生变化的模块，再用新输出的模块替换掉浏览器中对应的老模块。

- CDN 加速

  CDN 又叫内容分发网络，通过把资源部署到世界各地，用户在访问时按照就近原则从离用户最近的服务器获取资源，从而加速资源的获取速度。



